
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Page</title>

    <link rel="stylesheet" href="/public/styles.css">

</head>
    <body class="bg-white w-screen absolute z-0">  
    <div class="bg-gradient-to-r from-blue-500 to-indigo-500 w-screen h-64 mt-0 mx-0 px-4 z-10 absolute"></div>
    <div class="w-screen flex flex-col md:flex-row mt-20">
        <main class="bg-white p-10 rounded-3xl relative mx-5 md:max-w-[85%] md:mr-0 float-left items-start flex-col z-20"> 
            <!-- title area  -->
            <header class="title-area">
                <h1 class="font-body font-bold text-5xl text-black my-2">Visualizing the chemical space</h1>
                <div class="author-container my-5 flex flex-row content-center">
                    <img class="self-center object-fill h-10 w-10 rounded-full mr-5" src="/images/bob_smith.JPG" alt="could not render the beautiful face of this article's author :(">
                    <span class="author-name h-5 font-title text-blue-500 text-l flex justify-center">Melissa Du</span>
                    <span class="date font-bold font-title text-blue-500 text-l mx-2">11/02/22</span>
                </div>
                <div class="description font-body text-gray-400 italic">After creating models for drug classification, we need a practical way of visualizing our chemical space and verifying our results. This guide will walk you through how to generate an interactive plotly graph of chemicals that renders 2D images of molecules on hover.</div>
            </header>
            <div class="article font-body my-5">
                <div class="article-text text-black my-2">We will cover two different types of chemical representations (Morgan fingerprint and RDKit 2D molecular descriptors), two different techniques for dimension reduction (PCA and t-SNE), generating a scatterplot in plotly, and creating an interactive Dash app. All of the code is located in our ‚ÄúPutting Everything Together‚Äù section at the end, but we recommend reading through the sections to fully understand how everything works.</div>
                <div class="table-contents flex flex-col space-y-2 underline my-5 font-sans text-gray-500">
                    <a href="#chemical representations" class="text-md">Chemical Representations</a>
                    <a href="#morgan fingerprint" class="indent-5 text-sm">Morgan Fingerprint (Circular Fingerprint)</a>
                    <a href="#rdkit 2d normalized" class="indent-5 text-sm">RDKit 2D Normalized Descriptor</a>
                    <a href="#dimensionality reduction" class="text-md">Dimensionality Reduction</a>
                    <a href="#pca" class="indent-5 text-sm">Principal Component Analysis</a>
                    <a href="#tsne" class="indent-5 text-sm text-ellipsis">t-Distributed Stochastic Neighborhood Embedding</a>
                    <a href="#plotly" class="text-md">Graphing with Plotly</a>
                    <a href="#dash" class="text-md">Creating Dash App</a>
                    <a href="#dash layout" class="indent-5 text-sm">Basic Dash Layout</a>
                    <a href="#dash callback" class="indent-5 text-sm">Basic Dash Callback</a>
                    <a href="#everything" class="text-md">Putting Everything Together</a>
                    <a href="#references" class="text-md">References</a>
                </div>
                <div class="article-text text-black my-2">Let's get started! üôÇ</div>
                <!-- Chemical Representations -->
                <a id="chemical representations"><h3 class="font-body font-bold text-blue-500 text-3xl my-2 mt-5">Chemical representations</h3></a>
                <a id="morgan fingerprint"><h4 class="font-title text-black text-2xl my-2">Morgan Fingerprints</h4></a> 
                <div class="article-text text-black my-2">RDKit provides a function for converting SMILES into Morgan fingerprints that requires the fingerprint radius and number of bits. It is common to use a radius of 2 or 3 and at least 1024 bits. Higher bit values will allow you to retain more information about the molecule. </div>
                <div class="article-text text-black my-2">In order to perform PCA or t-SNE, we convert the fingerprint into a 1d numpy array. </div>
                <pre class="bg-gray-200 border-x-[25px] border-transparent py-5 my-5 text-gray-500 text-sm overflow-x-scroll"><div class="font-code"><span class="text-blue-300">from</span> rdkit <span class="text-blue-300">import</span> Chem, DataStructs
<span class="text-blue-300">from</span> rdkit.Chem <span class="text-blue-300">import</span> AllChem
<span class="text-blue-300">import</span> numpy as np

<span class="text-blue-300">def</span> <span class="text-red-300">fp_from_smiles</span>(smiles):
    mol = Chem.MolFromSmiles(smiles)
    fp = AllChem.GetMorganFingerprintAsBitVect(mol, 2, nBits=2048) <span class="text-gray-400"># generate MF as bit vector</span>
    fp = np.frombuffer(fp.ToBitString().encode(), 'u1') - ord('0') <span class="text-gray-400"># convert bit vector to 1d numpy array</span>
    <span class="text-blue-300">return</span> fp</div></pre>

                <a id="rdkit 2d normalized"><h4 class="font-title text-black text-2xl my-2">RDKit 2D Normalized Descriptor</h4></a>
                <div class="article-text text-black my-2"> <a href="https://github.com/bp-kelley/descriptastorus" target="_blank" class="underline text-gray-500">Descriptastorus</a> is a package for that allows us to efficiently generate a wide range of molecular descriptors from chemical SMILES. Luckily for us, they are also able to calculate and normalize the 2D molecular descriptors provided in RDKit.</div>
                <div class="article-text text-black my-2">The output of processing a SMILES on the RDKit2DNormalized generator is a 1d array.</div>
                <pre class="bg-gray-200 border-x-[25px] border-transparent py-5 my-5 text-gray-500 text-sm overflow-x-scroll"><div class="font-code"><span class="text-blue-300">from</span> rdkit <span class="text-blue-300">import</span> Chem, DataStructs
<span class="text-blue-300">from</span> descriptastorus.descriptors <span class="text-blue-300">import</span> rdNormalizedDescriptors

<span class="text-blue-300">def</span> <span class="text-red-300">rdnd_from_smiles</span>(smiles):
    generator = rdNormalizedDescriptors.RDKit2DNormalized()
    rdnd = generator.process(smiles)
    <span class="text-blue-300">return</span> rdnd</div></pre>
                
                <!-- Dimensionality Reduction -->
                <a id="dimensionality reduction"><h3 class="font-body font-bold text-blue-500 text-3xl my-2 mt-5">Dimensionality Reduction</h3></a>
                <a id="pca"><h4 class="font-title text-black text-2xl my-2">Principal Component Analysis</h4></a> 
                <div class="article-text text-black my-2">The scikit-learn package provides a function to perform PCA. We just need to pass in our dataset as an array of the molecules‚Äô chemical representations (chem_rep_list) and specify the number of components. To plot this on a graph, we are limited to 2 or 3 components.</div>
                <pre class="bg-gray-200 border-x-[25px] border-transparent py-5 my-5 text-gray-500 text-sm overflow-x-scroll"><div class="font-code"><span class="text-blue-300">from</span> rdkit <span class="text-blue-300">import</span> Chem, DataStructs
<span class="text-blue-300">from</span> sklearn.decomposition <span class="text-blue-300">import</span> PCA

<span class="text-blue-300">def</span> <span class="text-red-300">pca_df</span>(chem_rep_list):
    pca = PCA(n_components=<span class="text-red-500">2</span>)
    pca_arr = pca.fit_transform(chem_rep_list) 
    <span class="text-blue-300">return</span> pd.DataFrame(pca_arr,columns=[<span class="text-emerald-300">"Component 1"</span> ,<span class="text-emerald-300">"Component 2"</span>])</div></pre>

                <a id="tsne"><h4 class="font-title text-black text-2xl my-2">t-Distributed Stochastic Neighborhood Embedding</h4></a> 
                <div class="article-text text-black my-2">Alternatively, we can use t-SNE to reduce the number of dimensions. However, this technique is more computationally heavy, so it‚Äôs recommended to use PCA first to reduce the data down to around 50 dimensions. </div>
                <div class="article-text text-black my-2">The t-SNE function has many <a href="https://scikit-learn.org/stable/modules/generated/sklearn.manifold.TSNE.html" target="_blank" class="underline text-gray-500">parameters</a>. We recommend modifying them within a range as different values can give dramatically different results. </div>
                <pre class="bg-gray-200 py-5 border-x-[25px] border-transparent my-5 text-gray-500 text-sm overflow-x-scroll"><div class="font-code"><span class="text-blue-300">from</span> rdkit <span class="text-blue-300">import</span> Chem, DataStructs
<span class="text-blue-300">from</span> sklearn.manifold <span class="text-blue-300">import</span> TSNE

<span class="text-blue-300">def</span> <span class="text-red-300">tsne_df</span>(chem_rep_list):
    pca_50 = PCA(n_components=<span class="text-red-500">50</span>)
	pca_result_50 = pca_50.fit_transform(chem_rep_list)
	pca_50_variance = pca_50.explained_variance_ratio_
	tsne = TSNE(n_components=2, verbose=0, perplexity=40, n_iter=300)
	tsne_results = tsne.fit_transform(pca_result_50)mol = Chem.MolFromSmiles(smiles)
    <span class="text-blue-300">return</span> pd.DataFrame(tsne_results, columns=[<span class="text-emerald-300">"TSNE-1"</span>, <span class="text-emerald-300">"TSNE-2"</span>])</div></pre>

                <!-- Graphing with Plotly -->
                <div class="article-text text-black my-2">We can use any of the chemical representations above with any of the dimension reduction techniques. Let‚Äôs combine some of the code we‚Äôve written to create a function that allows us to generate a plotly graph. </div>
                <pre class="bg-gray-200 border-x-[25px] border-transparent py-5 my-5 text-gray-500 text-sm overflow-x-scroll"><div class="font-code"><span class="text-blue-300">from</span> rdkit <span class="text-blue-300">import</span> Chem, DataStructs
<span class="text-blue-300">from</span> sklearn.manifold <span class="text-blue-300">import</span> TSNE
                    
<span class="text-blue-300">def</span> <span class="text-red-300">graph_chemical_space</span>(
    df: pd.DataFrame,
    smiles_col: str = "SMILES",
    color_col: str = None,
    id_col: str = None,
    chem_rep: str = "rdkit",
    dim_reduction: str = "TSNE",
    graph_title: str = None
):
    <span class="text-emerald-300">
    """
    df : pandas.DataFrame object
        a pandas dataframe that contains the data plotted in fig.
    smiles_col : str, optional
        name of the column in df containing the smiles plotted in fig (default 'SMILES').
        If provided as a list, will add a slider to choose which column is used for rendering the structures.
    color_col : str, optional  
        name of the column in df that will specify the point colors plotted in fig (default None)
    id_col : str, optional  
        name of the column in df that will specify id of the points plotted in fig (default None)
    chem_rep : "rdkit" | "mf" | "oc" , optional
        name of the desired chemical representation 
    dim_reduction : "PCA" | "TSNE" , optional
        name of desired dimension reduction technique
    graph_title : str, optional
        title of graph
    """  
    </span> 
    assert chem_rep in ['rdkit', 'mf', 'oc'], "Please enter a valid chemical representation"
    assert dim_reduction in ["PCA", "TSNE"], "Please enter a valid dimension reduction technique"
    assert smiles_col in df, "The specified smiles_col is not in the dataframe"

    funcs = {
        "rdkit" : rdnd_from_smiles,
        "mf" : fp_from_smiles,
        "TSNE": tsne_df,
        "PCA": pca_df
    }
    
    mol_list = []
    # convert smiles to desired chemical representation
    for smiles in df[smiles_col]:
        mol_list.append(funcs[chem_rep](smiles))
    # apply desired dimension reduction technique
    rd_df = funcs[dim_reduction](mol_list) 
    # populate dataframe with color and id columns
    rd_df = rd_df.join(df[smiles_col])
    if id_col is not None:
        rd_df = rd_df.join(df[id_col])
    if color_col is not None:
        rd_df = rd_df.join(df[color_col])

    fig = px.scatter(rd_df, x='Component 1', y='Component 2', color=color_col, title=graph_title)
    return fig</div></pre>
                <div class="article-text text-black my-2">We will use the <a href="https://moleculenet.org/datasets-1" target="_blank">BACE dataset</a> and attempt to generate a chemical visualization that distinguishes molecules by pIC50. </div>
                <pre class="bg-gray-200 py-5 border-x-[25px] border-transparent my-5 text-gray-500 text-sm overflow-x-scroll"><div class="font-code"><span class="text-blue-300">from</span> rdkit <span class="text-blue-300">import</span> Chem, DataStructs
<span class="text-blue-300">import</span> pandas <span class="text-blue-300">as</span> pd

file_name = <span class="text-emerald-300">'bace.csv'</span> 
df = pd.read_csv(file_name)[[<span class="text-emerald-300">'mol'</span> ,<span class="text-emerald-300">'CID'</span> ,<span class="text-emerald-300">'pIC50'</span> ]]</div></pre>

                <div class="article-text text-black my-2">Here is a quick comparison of the different chemical representations and dimension reduction techniques: </div>
                <pre class="bg-gray-200 py-5 border-x-[25px] border-transparent my-5 text-gray-500 text-sm overflow-x-scroll"><div class="font-code">graph_chemical_space(df, smiles_col='mol', color_col='pIC50', id_col='CID', chem_rep='mf', dim_reduction='PCA', graph_title='Morgan Fingerprint + PCA')</div></pre>
                <img src="/images/mf+pca.png" alt="Can't render image" class="flex justify-center object-contain">
                <div class="flex justify-center text-black"><span class="font-bold">Figure 1. &nbsp;</span>  Morgan Fingerprint + PCA</div>

                <pre class="bg-gray-200 py-5 border-x-[25px] border-transparent my-5 text-gray-500 text-sm overflow-x-scroll"><div class="font-code">graph_chemical_space(df, smiles_col='mol', color_col='pIC50', id_col='CID', chem_rep='mf', dim_reduction='TSNE', graph_title='Morgan Fingerprint + TSNE')</div></pre>
                <img src="/images/mf+tsne.png" alt="Can't render image" class="flex justify-center object-contain">
                <div class="flex justify-center text-black"><span class="font-bold">Figure 2. &nbsp;</span>  Morgan Fingerprint + t-SNE</div>

                <pre class="bg-gray-200 py-5 border-x-[25px] border-transparent my-5 text-gray-500 text-sm overflow-x-scroll"><div class="font-code">graph_chemical_space(df, smiles_col='mol', color_col='pIC50', id_col='CID', chem_rep='rdkit', dim_reduction='PCA', graph_title='RDKit Descriptors + PCA')</div></pre>
                <img src="/images/rdkit+pca.png" alt="Can't render image" class="flex justify-center object-contain">
                <div class="flex justify-center text-black"><span class="font-bold">Figure 3. &nbsp;</span>  RDKit + PCA</div>

                <pre class="bg-gray-200 py-5 border-x-[25px] border-transparent my-5 text-gray-500 text-sm overflow-x-scroll"><div class="font-code">fig = graph_chemical_space(df, smiles_col='mol', color_col='pIC50', id_col='CID', chem_rep='rdkit', dim_reduction='TSNE', graph_title='RDKit Descriptors + TSNE')</div></pre>
                <img src="/images/rdkit+tsne.png" alt="Can't render image" class="flex justify-center object-contain">
                <div class="flex justify-center text-black"><span class="font-bold">Figure 4. &nbsp;</span>  RDKit + t-SNE</div>
                
                <a id="dash"><h3 class="font-body font-bold text-blue-500 text-3xl my-2 mt-5">Creating Dash App</h3></a>
                <div class="article-text text-black my-2">Now that we‚Äôve generated some graphs, we‚Äôre onto the last step of this process: displaying 2D images of the molecules on hover! For this, we will be using Dash, a python framework for creating interactive web applications. </div>
                <a id="dash layout"><h4 class="font-title text-black text-2xl my-2">Basic Dash Layout</h4></a> 
                <div class="article-text text-black my-2">A Dash app is composed of a tree of nested components that can take the form of </div>
                <ol class="list-decimal list-outside text-black pl-10">
                    <li class="pl-5">HTML elements (<code class="bg-gray-300 font-code text-pink-700 p-px">dash.html</code>): basic components like headers, paragraphs, images</li>
                    <li class="pl-5">Dash Core Component elements (<code class="bg-gray-300 font-code text-pink-700 p-px">dash.dcc</code>): higher-level, interactive components like graphs, drop-downs, tooltips</li>
                </ol>
                <div class="article-text text-black my-2">All components can be given an identifying id for future reference. HTML components can be styled with a CSS dictionary.</div>
                <div class="article-text text-black my-2">Our app will be composed of a DCC Graph component that renders our plotly graph and a DCC Tooltip that allows the user to point to a precise location on the graph.</div>
                <div class="article-text text-black my-2">The following code generates a basic Dash app that displays the plotly graph above without any hover functionality. Note that we are using JupyterDash, which gives us the option to display the graph inline in a Jupyter notebook in addition to externally on a web browser. </div>
                <div class="article-text text-black my-2">Setting <code class="bg-gray-300 font-code text-pink-700 p-px">debug=True</code> in <code class="bg-gray-300 font-code text-pink-700 p-px">app.run_server</code> allows the app to update in real-time as changes are being made to the code. Additionally, a port must be specified (default is 8050) and forwarded to display the app interface inline. Make sure you manually forward the port in a Jupyter notebook as the app will not fully render otherwise.</div>
                <pre class="bg-gray-200 border-x-[25px] border-transparent py-5 my-5 text-gray-500 text-sm overflow-x-scroll"><div class="font-code"><span class="text-blue-300">from</span> rdkit <span class="text-blue-300">import</span> Chem, DataStructs
fig = graph_chemical_space(df, smiles_col='mol', color_col='pIC50', id_col='CID', chem_rep='rdkit', dim_reduction='TSNE', graph_title='RDKit Descriptors + TSNE')
fig.update_traces(hoverinfo="none", hovertemplate=None) # remove all previous hover info, no selector or col/row specificed
app = JupyterDash(__name__)
app.layout = html.Div(
    [
        dcc.Graph(id="graph", figure=fig, clear_on_unhover=True),
        dcc.Tooltip(id="graph-tooltip"),
    ]
)
app.run_server(debug=True, port='8050')</div></pre>  
                <a id="dash app"><h4 class="font-title text-black text-2xl my-2">Basic Dash Callback</h4></a> 
                <div class="article-text text-black my-2">In order to display molecules on hover, we need to add interactivity to our app. More specifically, we want to add a callback function that updates our Dash interface whenever we hover over a point on the graph. </div>
                <div class="article-text text-black my-2">Callbacks are handled by the <code class="bg-gray-300 font-code text-pink-700 p-px">@app.callback</code> decorator, which which takes in input and output arguments. The inputs and outputs of <code class="bg-gray-300 font-code text-pink-700 p-px">@app.callback</code> are properties of components, which are referenced by their ids.  </div>
                <div class="article-text text-black my-2">The decorator causes the function that it wraps to be called anytime there are modifications to the input components. Therefore, the wrapped function must specify how the output should be updated. This function must be written directly after the <code class="bg-gray-300 font-code text-pink-700 p-px">@app.callback</code> decorator (no empty lines) and take in input properties as arguments.</div>
                <div class="article-text text-black my-2">In our case, the input is the hoverData attribute from the Graph component and our output is the data displayed by our Tooltip component. </div>
                <pre class="bg-gray-200 border-x-[25px] border-transparent py-5 my-5 text-gray-500 text-sm overflow-x-scroll"><div class="font-code"><span class="text-blue-300">from</span> rdkit <span class="text-blue-300">import</span> Chem, DataStructs

@app.callback(
    Output("graph-tooltip", "show"),
    Output("graph-tooltip", "bbox"),
    Output("graph-tooltip", "children"),
    Input("graph", "hoverData"), 
)</div></pre>
                <div class="article-text text-black my-2">Now, we have to define a function that describes how our Tooltip is updated in response to changes in the Graph‚Äôs hoverData. This function should:</div>
                <ol class="list-decimal list-outside text-black pl-10">
                    <li class="pl-5">Generate a 2D molecule image from a SMILES that can be displayed in an HTML Image component.</li>
                    <li class="pl-5">Display an HTML Div that contains this image, along with the molecule name and any other captions that are specified.</li>
                </ol>
            
            </div>
        </main>
        <nav class="invisible md:sticky md:visible px-10 flex flex-col space-y-5 top-1/2 -translate-y-1/2 self-start">
            <a href="#">
                <img src="/images/facebook.png" alt="" class="max-h-12 object-contain">
            </a>
            <a href="#">
                <img src="/images/twitter.png" alt="" class="max-h-12 object-contain">
            </a>
            <a href="#">
                <img src="/images/email.png" alt="" class="max-h-12 object-contain">
            </a>
            <a href="#">
                <img src="/images/discord.png" alt="" class="max-h-12 object-contain">
            </a>
            <a href="#">
                <img src="/images/heart.png" alt="" class="max-h-12 object-contain">
            </a>
            <a href="#">
                <img src="/images/comment.png" alt="" class="max-h-12 object-contain">
            </a>
        </nav>
    </div>
    <div class="read-more my-10">
        <h3 class="font-body text-blue-500 text-5xl mx-10">Read more...</h3>
        <div class="flex flex-row space-x-20 my-10">
            <div class="article-card w-64">
                <img src="", alt="">
                <div class="card-text bg-gray-200">
                    <span>Visualizing chemical space</span>
                    <span>By John Smith</span>
                </div>
            </div>
            <div class="article-card w-64">
                <img src="images/meme.jpeg", alt="">
                <div class="card-text">
                    <span>Visualizing chemical space</span>
                    <span>By John Smith</span>
                </div>
            </div>
            <div class="article-card w-64">
                <img src="images/dog.jpeg", alt="">
                <div class="card-text">
                    <span>Visualizing chemical space</span>
                    <span>By John Smith</span>
                </div>
            </div>
        </div>
    </div>
    <div class="comments-section my-10">
        <h3 class="font-body text-black text-5xl mx-10">Comments</h3>
        <form class="comments">
            <div class="comment-profile">
                <img src="" alt="">
            </div>
            <div class="comment-box">
                <textarea name="comment" id="comment" cols="30" rows="10"></textarea>
            </div>
        </form>
    </div>
</body>
</html>